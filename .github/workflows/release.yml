name: Build and Release

on:
  push:
    tags:
      - 'v*' # v0.1, v1.0.0 などのタグがプッシュされたら発動

permissions:
  contents: write

jobs:
  build:
    name: Build Executables
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' 

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # requirements.txt があればインストール、なければ個別に
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          } else {
            pip install tk nfcpy pyserial google-api-python-client google-auth-oauthlib pygame
          }
          # pyinstallerは必ずインストール
          pip install pyinstaller

      - name: Build Executables with PyInstaller
        run: |
          # 1. ソースコードのルート場所を探す (launcher.py を基準にする)
          $launcher = Get-ChildItem -Path . -Filter "launcher.py" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($null -eq $launcher) {
            Write-Error "エラー: launcher.py が見つかりません。ファイルをコミットしているか確認してください。"
            exit 1
          }
          
          $srcDir = $launcher.DirectoryName
          Write-Host "ソースディレクトリ: $srcDir"
          
          # 2. ビルド実行場所へ移動
          Set-Location $srcDir
          
          # 3. 出力先の設定
          if ($srcDir.EndsWith("src")) {
            $distRoot = "../dist"
            $distBin = "../dist/bin"
          } else {
            $distRoot = "dist"
            $distBin = "dist/bin"
          }
          
          # --- ビルド関数 (引数でオプション追加可能) ---
          function Build-Exe ($scriptName, $outDir, $noconsole, $extraArgs) {
            # ファイル探索
            if (Test-Path $scriptName) {
              $targetPath = $scriptName
            } else {
              $found = Get-ChildItem -Path . -Filter $scriptName -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                $targetPath = $found.FullName
              } else {
                $targetPath = $null
              }
            }

            if ($targetPath) {
              Write-Host "Building $targetPath ..."
              # 基本引数
              $args = @("--onefile", "--distpath", $outDir, $targetPath)
              
              # オプション追加
              if ($noconsole) { $args += "--noconsole" }
              if ($extraArgs) { $args += $extraArgs }
              
              # ★修正: python -m 経由で呼び出すことでPATH問題を回避
              python -m PyInstaller $args
            } else {
              Write-Error "エラー: $scriptName が見つかりません！"
              exit 1
            }
          }
          
          # --- nfcpy用の隠れインポートオプション ---
          $nfcOpts = @("--hidden-import=nfc.clf.rcs380", "--hidden-import=nfc.clf.transport")

          # 4. 各スクリプトのビルド実行
          
          # ランチャー
          Build-Exe "launcher.py" $distRoot $true $null
          
          # GUIアプリ
          Build-Exe "gui_main.py" $distBin $true $null
          Build-Exe "gui_signal.py" $distBin $true $null
          
          # CUIツール (nfcpyを使うものはオプション追加)
          Build-Exe "remote_entry.py" $distBin $false $nfcOpts
          Build-Exe "drive_uploader.py" $distBin $false $null
          
          # Writer (ルート配置、nfcpy使用)
          Build-Exe "writer.py" $distRoot $false $nfcOpts

      - name: Organize Assets
        run: |
          # 再度ソース場所取得
          $launcher = Get-ChildItem -Path . -Filter "launcher.py" -Recurse | Select-Object -First 1
          $srcDir = $launcher.DirectoryName
          if ($srcDir.EndsWith("src")) { $distBase = "dist" } else { $distBase = "dist" }
          
          # binフォルダ確保
          if (-not (Test-Path "$distBase/bin")) { New-Item -ItemType Directory -Force -Path "$distBase/bin" }

          # 1. 音声ファイルのコピー
          $wavFiles = Get-ChildItem -Path . -Filter "*.wav" -Recurse
          foreach ($file in $wavFiles) {
            if ($file.FullName -notlike "*\dist\*") {
              Copy-Item $file.FullName -Destination "$distBase/bin" -Force
            }
          }
          
          # 2. READMEのコピー
          $readme = Get-ChildItem -Path . -Filter "README.md" -Recurse | Select-Object -First 1
          if ($readme) {
            Copy-Item $readme.FullName -Destination $distBase -Force
          }

          # 3. config.ini テンプレート作成
          $configContent = @"
          [GoogleDrive]
          # ここにアップロード先のフォルダIDを書いてください
          FolderID = 
          
          [System]
          DataDir = gymkhana_data
          "@
          $configPath = Join-Path $distBase "config.ini"
          Set-Content -Path $configPath -Value $configContent -Encoding UTF8

      - name: Create ZIP Archive
        run: |
          if (Test-Path "dist") {
            Compress-Archive -Path dist\* -DestinationPath GymkhanaSystem_${{ github.ref_name }}.zip
          } else {
            Write-Error "distフォルダがありません。"
            exit 1
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: GymkhanaSystem_${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
