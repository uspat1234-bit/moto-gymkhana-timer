name: Build and Release

on:
  push:
    tags:
      - 'v*' # v0.1, v1.0.0 などのタグがプッシュされたら発動

permissions:
  contents: write

jobs:
  build:
    name: Build Executables
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' 

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # requirements.txt があればインストール、なければ個別に
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          } else {
            pip install tk nfcpy pyserial google-api-python-client google-auth-oauthlib pygame
          }
          pip install pyinstaller

      - name: Build Executables with PyInstaller
        run: |
          # 1. ソースコードのルート場所を探す
          $launcher = Get-ChildItem -Path . -Filter "launcher.py" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($null -eq $launcher) {
            Write-Error "エラー: launcher.py が見つかりません。"
            exit 1
          }
          
          $srcDir = $launcher.DirectoryName
          Write-Host "ソースディレクトリ: $srcDir"
          
          # 2. ビルド実行場所へ移動
          Set-Location $srcDir
          
          # 3. 出力先の設定
          if ($srcDir.EndsWith("src")) {
            $distRoot = "../dist"
            $distBin = "../dist/bin"
          } else {
            $distRoot = "dist"
            $distBin = "dist/bin"
          }
          
          # --- ビルド関数 ---
          function Build-Exe ($scriptName, $outDir, $noconsole, $extraArgs) {
            if (Test-Path $scriptName) {
              $targetPath = $scriptName
            } else {
              $found = Get-ChildItem -Path . -Filter $scriptName -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) { $targetPath = $found.FullName } else { $targetPath = $null }
            }

            if ($targetPath) {
              Write-Host "Building $targetPath ..."
              $args = @("--onefile", "--distpath", $outDir, $targetPath)
              if ($noconsole) { $args += "--noconsole" }
              if ($extraArgs) { $args += $extraArgs }
              python -m PyInstaller $args
            } else {
              Write-Error "エラー: $scriptName が見つかりません！"
              exit 1
            }
          }
          
          # nfcpy用オプション
          $nfcOpts = @("--hidden-import=nfc.clf.rcs380", "--hidden-import=nfc.clf.transport")

          # 4. ビルド実行 (すべて bin に入れる)
          Build-Exe "launcher.py" $distBin $true $null
          Build-Exe "gui_main.py" $distBin $true $null
          Build-Exe "gui_signal.py" $distBin $true $null
          
          Build-Exe "remote_entry.py" $distBin $false $nfcOpts
          Build-Exe "drive_uploader.py" $distBin $false $null
          
          Build-Exe "writer.py" $distBin $false $nfcOpts

      - name: Organize Assets & Create Launchers
        run: |
          # パス再設定
          $launcher = Get-ChildItem -Path . -Filter "launcher.py" -Recurse | Select-Object -First 1
          $srcDir = $launcher.DirectoryName
          if ($srcDir.EndsWith("src")) { $distBase = "dist" } else { $distBase = "dist" }
          $distBin = "$distBase\bin"
          
          # binフォルダ確保
          if (-not (Test-Path $distBin)) { New-Item -ItemType Directory -Force -Path $distBin }

          # 1. 音声ファイルのコピー
          $wavFiles = Get-ChildItem -Path . -Filter "*.wav" -Recurse
          foreach ($file in $wavFiles) {
            if ($file.FullName -notlike "*\dist\*") {
              Copy-Item $file.FullName -Destination $distBin -Force
            }
          }
          
          # 2. READMEのコピー
          $readme = Get-ChildItem -Path . -Filter "README.md" -Recurse | Select-Object -First 1
          if ($readme) { Copy-Item $readme.FullName -Destination $distBase -Force }

          # 3. config.ini テンプレート作成 (bin内)
          $configContent = @"
          [GoogleDrive]
          FolderID = 
          [System]
          DataDir = gymkhana_data
          "@
          $configPath = Join-Path $distBin "config.ini"
          Set-Content -Path $configPath -Value $configContent -Encoding UTF8

          # 4. ★変更: 起動用バッチファイルの作成 (ルートに配置)
          # これなら相対パスで動作するため、配布先でもリンク切れしません。
          
          # Launcher.bat
          $batLauncher = '@echo off' + "`r`n" + 'start "" "bin\launcher.exe"'
          Set-Content -Path "$distBase\Launcher.bat" -Value $batLauncher -Encoding Default
          
          # Writer.bat
          $batWriter = '@echo off' + "`r`n" + 'start "" "bin\writer.exe"'
          Set-Content -Path "$distBase\Writer.bat" -Value $batWriter -Encoding Default
          
          # Config.bat (メモ帳で開く)
          $batConfig = '@echo off' + "`r`n" + 'notepad "bin\config.ini"'
          Set-Content -Path "$distBase\Config.bat" -Value $batConfig -Encoding Default
          
          Write-Host "Created Batch files in root directory."

      - name: Create ZIP Archive
        run: |
          if (Test-Path "dist") {
            Compress-Archive -Path dist\* -DestinationPath GymkhanaSystem_${{ github.ref_name }}.zip
          } else {
            Write-Error "dist folder missing."
            exit 1
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: GymkhanaSystem_${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
